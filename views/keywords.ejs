<!DOCTYPE html>
<html>
  <head>
    <link rel='stylesheet' href='/Bootstrap-3.3.7/css/bootstrap.css' />
    <script type="text/javascript" src="/jQuery-3.3.1/jquery-3.3.1.js"></script>
    <link href="https://unpkg.com/tabulator-tables@4.7.1/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.7.1/dist/js/tabulator.min.js"></script>

    <script>
      var category2 = '<%= cate2 %>'
      var ctable;
      var insertData = ( dataArray ) => {
        if( dataArray !== undefined && dataArray.length < 1){
          console.log("No updating data")
        } else {
          $.ajax({
            url : "http://localhost:3000/category/insertData",
            type : "POST",
            data : JSON.stringify(dataArray),
            contentType : "application/json",
            // dataType : "text",
            error : function(e){
              console.log(e)
            },
            success : function( response ){
              if(response == "OK"){
                ctable.setData();
              } else {
                alert("not successful")
              }
            }
          })
        }
      }

      var loadData = (cate1) => {
        var url = "http://localhost:3000/category/getTableData?cate1="
        ctable.setData(url + cate1)
      }

      var printChk = (cell, formatterParams, onRendered) => {
        return "<input type='checkbox'>"        
      }

      var prtCntLnk = (cell, formatterParams, onRendered) => {
        return `<a href='http://localhost:3000/keywords/getTableData'> ${cell.getValue()} </a>`;
      }
      
      $(document).ready( function(){
        console.log("category2 : " + category2)
        ctable = new Tabulator("#tb_category2", {
          ajaxURL : "http://localhost:3000/keywords/getTableData?category2=" + category2,
          //ajaxParams : { size : "1" },
          ajaxConfig : "GET",
          layout : "fitData",
          columns : [
            {title : "<input type='checkbox'>", hozAlign:"center", formatter:printChk },
            {title : "esID", field : "isNew", hozAlign:"center", visible: false },
            {title : "대분류", width: 100, field : "category1", hozAlign:"center", visible: false },
            {title : "중분류", width: 300, field : "category2", hozAlign:"center", visible: false },
            {title : "키워드", width: 100, field : "keyword", editor: "input", hozAlign:"center", formatterParams : {add : false} },
            {title : "동의어", width: 300, field : "", editor: "input", hozAlign:"center" },
            {title : "연관어", width: 300, field : "", editor: "input", hozAlign:"center" },
            {title : "오류키워드", width: 300, field : "", editor: "input", hozAlign:"center", formatterParams : {add : false} },
            {title : "삭제", field : "tbutton", hozAlign:"center", width: 70 , formatter: "buttonCross" },
            {title : "신규여부", field : "isNew", hozAlign:"center", visible: false },
            {title : "수정여부", field : "isEdited", hozAlign:"center", visible: false },
          ],

          pagination : "local",
          paginationSize : 20,
          height : "500px",
          // width : "300px",
          cellEdited : function(cell){
            var rowData = cell.getRow().getData();
            if(rowData.isNew !== "Y"){
              rowData.isEdited = "Y"
            }           
          }

        })

        document.getElementById("add-row").addEventListener("click", function(){
          ctable.addData([{  count: 0 , isNew : "Y"}], true); // default 는 false이고 true이면 행이 위에 생긴다.
          // ctable.addData([{ cate2 : null, count : 0 }], true); // default 는 false이고 true이면 행이 위에 생긴다.
        });

        document.getElementById("updt-data").addEventListener("click", function(){
          var data = ctable.getData();
          var udata = data.filter( v => v.isNew === "Y" && v.cate2 !== undefined || v.isEdited === "Y" && v.cate2 !== undefined)                                                                                                                                  
          insertData(udata)  
        });

        /* Test : 잘 됨
        document.getElementById("ct1_2").addEventListener("click", function(){
          console.log( document.querySelector("#ct1_2").textContent );  
        })
        */

        let ulList = document.querySelectorAll("ul[id^='category2s_'")
        for( ul of ulList ){
          ul.style.visibility='hidden';
        }

        let liList = document.querySelectorAll("#category1s > li")
        for( li of liList){
          li.addEventListener("click", function(){
            console.log("clicked")
          })

        
        }

      });

    </script>
  </head>
  <body>
    <div class="row">
      <div class="col-md-2">
        <h4 style="margin-top: 30px; text-align: center; " > 카테고리 </h4>
        <ul style="margin-top: 30px;" id="category1s">
          <% for(let i = 0; i < ctList.length; i++) { %>
            <li id="ct1_<%= i %>"> <%= ctList[i].key %> ( <%= ctList[i].ct2.buckets.length %> ) </li>
            <ul id="category2s_<%= i %>">
              <li> 전체 ( <%= ctList[i].doc_count %> ) </li>
              <% for(let j = 0; j < ctList[i].ct2.buckets.length ; j++ ) { %>
                <li> 
                  <%= ctList[i].ct2.buckets[j].key %> ( <%= ctList[i].ct2.buckets[j].doc_count %> ) 
                </li>
              <% } %>
            </ul>            
          <% } %>
        </ul>
      </div>
      <div class="col-md-8">
        <h4 style="margin-top: 30px; margin-bottom: 50px;text-align: center;" > 키워드 목록 </h4>
        <div style="padding: 50px 50px 50px 100px;">
          <form>
            <input type="text"> 
            <button>검색</button>
          </form>
        </div>

        <h4>
          <button id="updt-data"> 저장 </button>
          <button id="add-row"> 추가 </button>
        </h4>
        <div id="tb_category2">
          <!-- 타뷸레이터 테이블 생성 -->
        </div>
      </div>
      <div class="col-md-2"></div>
    </div>

  </body>
</html>
