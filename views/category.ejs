<!DOCTYPE html>
<html>
  <head>
    <link rel='stylesheet' href='/Bootstrap-3.3.7/css/bootstrap.css' />
    <link rel='stylesheet' href='/Bootstrap-3.3.7/css/bootstrap-treeview.min.css' />
    <!--
    <link rel='stylesheet' href='/stylesheets/jquery-ui.css' />
    <script type="text/javascript" src="/jQuery-3.3.1/jquery-ui.min.js"></script>
    -->
    <link rel='stylesheet' href='/stylesheets/tabulator_bootstrap.min.css' />
    <script type="text/javascript" src="/javascripts/tabulator.min.js"></script>
    <script type="text/javascript" src="/javascripts/xlsx.full.min.js"></script>
    <script type="text/javascript" src="/jQuery-3.3.1/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="/Bootstrap-3.3.7/js/bootstrap.min.js"></script>
    
    <script type="text/javascript" src="/Bootstrap-3.3.7/js/bootstrap-treeview.min.js"></script>

    <script>

      var ctable;
      var cateTree = "<%= JSON.stringify(cateTree) %>".replace(/&#34;/gi,'"')
      var insertData = ( dataArray ) => {
        if( dataArray !== undefined && dataArray.length < 1){
          console.log("No updating data")
        } else {
          $.ajax({
            url : "http://localhost:3000/category/insertData",
            type : "POST",
            data : JSON.stringify(dataArray),
            contentType : "application/json",
            // dataType : "text",
            error : function(e){
              console.log(e)
            },
            success : function( response ){
              if(response == "OK"){
                ctable.setData();
              } else {
                alert("not successful")
              }
            }
          })
        }
      }

      var loadData = (cate1) => {
        console.log(cate1)
        var url = "http://localhost:3000/category/getTableData?cate1="
        ctable.setData(url + cate1)
      }

      var printChk = (cell, formatterParams, onRendered) => {
        return "<input type='checkbox'>"        
      }

      var prtCntLnk = (cell, formatterParams, onRendered) => {
        return `<a href='http://localhost:3000/keywords?category1=${cell.getRow().getData().cate1}&category2=${cell.getRow().getData().cate2}'> 
          ${cell.getValue()} </a>`;
                  
      }

      // table.setData로 처리하는 것도 한 방법일 수도...
      // table.setData(URL) 이런식으로 아쟉스 요청 가능
      // table.setData() 이러면 리로드 됨.
      
      $(document).ready( function(){

        ctable = new Tabulator("#tb_category2", {
          ajaxURL : "http://localhost:3000/category/getTableData",
          //ajaxParams : { size : "1" },
          ajaxConfig : "GET",
          layout : "fitData",
          //ajaxContentType:"json",
          columns : [
            
            {title : "<input type='checkbox'>", hozAlign:"center", formatter:printChk },
            {title : "중분류", field : "cate2", width: 200, editor: "input"},
            {title : "키워드 수", field : "count", formatter:prtCntLnk, hozAlign:"center", formatterParams : {add : false} },
            {title : "삭제", field : "tbutton", hozAlign:"center", width: 70 , formatter: "buttonCross" },
            {title : "신규여부", field : "isNew", hozAlign:"center", visible: false },
            {title : "수정여부", field : "isEdited", hozAlign:"center", visible: false },
            {title : "esID", field : "isNew", hozAlign:"center", visible: false },
            {title : "대분류", field : "cate1", hozAlign:"center", visible: false },
          ],
          pagination : "local",
          paginationSize : 20,
          height : "500px",
          width : "300px",
          //tableBuilt : function(){ console.log("table built")},
          cellEdited : function(cell){
            var rowData = cell.getRow().getData();
            if(rowData.isNew !== "Y"){
              rowData.isEdited = "Y"
            }           
          }

        })
        //console.log(ctable)
        document.getElementById("add-row").addEventListener("click", function(){
          ctable.addData([{  count: 0 , isNew : "Y"}], true); // default 는 false이고 true이면 행이 위에 생긴다.
        });

        document.getElementById("updt-data").addEventListener("click", function(){
          var data = ctable.getData();
          var cate1 = $('.list-group > li[class*=node-selected]')[0]
          var udata = data.filter( v => v.isNew === "Y" && v.cate2 !== undefined || v.isEdited === "Y" && v.cate2 !== undefined)  
          if(cate1 === undefined){
            alert("대분류를 선택하세요")
          } else {
            for( d of udata){
              d.cate1 = cate1.innerText.substr(0, cate1.innerText.indexOf(' ('))
            }
          }
          console.log(cate1.innerText)                                                                                                                                   
          insertData(udata)  

        });

        document.getElementById("addCategory1").addEventListener("click", function(){
          // 이거는 하나씩만 입력하도록 검사해야함 
          console.log(  )
          if( $('#cate1wrapper')[0] !== undefined ){
            return
          } else {
            // 대분류 추가버튼 + 클릭시 이벤트
            // console.log("대분류추가")
            // var newEl = $(".list-group > li:nth-child(1)")
            // var buttonSave = '<button id="saveCate1">저장</button>' 버튼 없이 엔터로만 입력
            var input = '<input type="text" id="newCate1"><button id="cancelCate1">x</button>'
            $( `<li class="list-group-item node-tree" id="cate1wrapper">${input}</li>`).prependTo(".list-group")
            document.getElementById("newCate1").addEventListener("keydown", function(key){
              if(key.code == "Enter"){
                console.log("save")
                var value = $('#newCate1').val()
                if(value !== '' && value !== undefined){
                  var data = [{ cate1 : value, cate2 : value, keyword : value, isNew : "Y" }]
                  console.log(data)
                } else {
                  alert('입력값이 유효하지 않습니다.')
                }
              }
            })
            document.getElementById("cancelCate1").addEventListener("click", function(){
              $('#cate1wrapper').remove();
            })
          }

        });
        
        $('#tree').treeview({
            data : cateTree,
            onNodeSelected : function( event, data ){
              
              loadData(data.text.substr(0, data.text.indexOf(' (')))
            }
        });




      });

    </script>
  </head>
  <body>
    <div class="row">
      <div class="col-md-2">
        <span>
          <h4 style="margin-top: 30px;"> 대분류 <button class="btn btn-warning btn-xs" id="addCategory1">+</button></h4>
          
        </span>
        <div id="tree"></div>
      </div>
      <div class="col-md-8">
        <h4 style="margin-top: 30px; margin-bottom: 50px;text-align: center;" >카테고리 목록</h4>
        <div style="padding: 50px 50px 50px 100px;">
          <form>
            <input type="text"> 
            <button>검색</button>
          </form>
        </div>

        <h4>
          <button id="updt-data"> 저장 </button>
          <button id="add-row"> 추가 </button>
          <button id="mrg-row"> 병합 </button>
        </h4>
        <div id="tb_category2">

        </div>
      </div>
      <div class="col-md-2"></div>
    </div>

  </body>
</html>
